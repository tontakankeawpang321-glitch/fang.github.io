<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Straw Market | ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ü‡∏≤‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root {
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏±‡∏ô ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ (Dark Straw Theme) */
        --primary: #fbbf24; /* Amber 400 - ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á‡∏ô‡∏ß‡∏• */
        --secondary: #d97706; /* Amber 600 - ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏≠‡∏á */
        --accent: #f59e0b; /* Amber 500 */
        --bg-dark: #1c1917; /* Stone 900 - ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏î‡∏™‡∏ô‡∏¥‡∏ó */
        --bg-card: #292524; /* Stone 800 - ‡∏™‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î */
        --text-main: #fef3c7; /* Amber 100 - ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏ô‡∏ß‡∏• */
        --text-muted: #a8a29e; /* Stone 400 */
    }

    body { 
        font-family: 'Prompt', sans-serif; 
        background-color: var(--bg-dark); 
        color: var(--text-main); 
        -webkit-tap-highlight-color: transparent; 
    }

    body.no-scroll {
        overflow: hidden;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 10px; }
    
    dialog {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: scale(0.95) translateY(10px);
        border: none;
        outline: none;
        background-color: var(--bg-card);
        color: var(--text-main);
    }
    dialog[open] { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
    dialog::backdrop { 
        background: rgba(0, 0, 0, 0.85); 
        backdrop-filter: blur(10px); 
    }
    
    .transition-all-300 { transition: all 0.3s ease; }
    
    .slider-hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
    .slider-visible { opacity: 1; pointer-events: auto; transform: scale(1); }

    .btn-animate:active { transform: scale(0.96); }
    
    .glass-nav {
        background: rgba(28, 25, 23, 0.8);
        backdrop-filter: blur(12px);
    }

    .custom-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }

    input, select, textarea {
        background-color: #44403c !important;
        color: var(--text-main) !important;
        border-color: #57534e !important;
        transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--accent) !important;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
    }

    .field-error {
        border-color: #ef4444 !important;
        background-color: #450a0a !important;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .img-fallback {
        background-color: #44403c;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Header Section -->
<nav class="glass-nav border-b border-stone-800 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer group" onclick="refreshApp()">
        <div class="bg-gradient-to-tr from-[#d97706] to-[#fcd34d] text-stone-900 p-2.5 rounded-2xl shadow-lg group-hover:rotate-6 transition-all-300">
            <i class="fa-solid fa-wheat-awn text-xl"></i>
        </div>
        <div class="hidden xs:block">
            <span class="font-bold text-lg sm:text-xl text-[#fbbf24] tracking-tight block leading-none">Straw<span class="text-white">Market</span></span>
            <span class="text-[9px] sm:text-[10px] text-stone-400 font-bold uppercase tracking-[0.2em]">Dark Edition</span>
        </div>
      </div>
      
      <!-- Desktop Actions -->
      <div class="hidden lg:flex items-center gap-4">
         <div class="flex bg-stone-800 p-1 rounded-2xl border border-stone-700">
             <select id="filter_province_desktop" class="bg-transparent px-4 py-2 text-sm outline-none cursor-pointer border-r border-stone-700 text-[#fbbf24] font-medium">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
             </select>
             <div class="relative">
                 <input id="q_desktop" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏≤‡∏á‡∏Å‡πâ‡∏≠‡∏ô..." class="bg-transparent pl-10 pr-4 py-2 text-sm w-56 outline-none text-white">
                 <i class="fa-solid fa-search absolute left-4 top-2.5 text-stone-500"></i>
             </div>
         </div>
         <button onclick="openNewPostModal()" class="bg-[#d97706] hover:bg-[#b45309] text-stone-900 px-6 py-2.5 rounded-xl shadow-xl flex items-center gap-2 btn-animate font-bold transition-all-300 text-sm">
            <i class="fa-solid fa-plus-circle"></i> ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
         </button>
      </div>
      
      <!-- Mobile Actions -->
      <div class="lg:hidden flex items-center gap-2">
         <button onclick="openNewPostModal()" class="bg-[#d97706] text-stone-900 w-11 h-11 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-transform">
            <i class="fa-solid fa-plus text-lg"></i>
         </button>
      </div>
  </div>
</nav>

<!-- Mobile Search Bar -->
<div class="lg:hidden bg-stone-900/90 backdrop-blur-md border-b border-stone-800 p-2 sticky top-16 z-40">
    <div class="flex gap-1.5 max-w-2xl mx-auto">
        <select id="filter_province_mobile" class="border border-stone-700 rounded-xl px-2 py-1.5 text-[10px] bg-stone-800 outline-none w-[35%] font-medium text-[#fbbf24]">
            <option value="all">‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà</option>
        </select>
        <div class="relative w-[65%]">
            <input id="q_mobile" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®..." class="w-full pl-8 pr-2 py-1.5 bg-stone-800 border border-stone-700 rounded-xl text-[10px] outline-none text-white">
            <i class="fa-solid fa-search absolute left-3 top-2 text-stone-500"></i>
        </div>
    </div>
</div>

<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">
    <div class="mb-6 text-center sm:text-left">
        <div class="inline-block bg-amber-900/30 text-amber-400 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider mb-2 border border-amber-800/50">üåæ Straw Marketplace</div>
        <h1 class="text-2xl sm:text-4xl font-extrabold text-white tracking-tight">‡∏ï‡∏•‡∏≤‡∏î‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏≠‡∏±‡∏î‡∏Å‡πâ‡∏≠‡∏ô</h1>
        <p class="text-stone-400 text-xs sm:text-lg mt-1 font-medium">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ã‡∏∑‡πâ‡∏≠-‡∏Ç‡∏≤‡∏¢‡∏ü‡∏≤‡∏á ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì</p>
    </div>
    
    <div id="loading" class="flex flex-col items-center justify-center py-20 hidden">
        <div class="w-10 h-10 border-4 border-stone-800 border-t-amber-500 rounded-full animate-spin mb-4"></div>
        <p class="text-stone-500 font-medium text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</p>
    </div>
    
    <section id="board" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-6 pb-12"></section>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-3 pb-16">
        <button onclick="changePage(-1)" id="btnPrev" class="w-9 h-9 bg-stone-800 border border-stone-700 rounded-xl flex items-center justify-center text-amber-500 hover:bg-stone-700 disabled:opacity-30 transition-all shadow-lg"><i class="fa-solid fa-arrow-left text-xs"></i></button>
        <span id="pageIndicator" class="text-xs font-bold text-amber-200 bg-stone-800 px-4 py-2 rounded-xl border border-stone-700 shadow-inner">1 / 1</span>
        <button onclick="changePage(1)" id="btnNext" class="w-9 h-9 bg-stone-800 border border-stone-700 rounded-xl flex items-center justify-center text-amber-500 hover:bg-stone-700 disabled:opacity-30 transition-all shadow-lg"><i class="fa-solid fa-arrow-right text-xs"></i></button>
    </div>
</main>

<footer class="bg-black text-stone-500 py-10 px-6 border-t border-stone-900">
    <div class="max-w-7xl mx-auto flex flex-col items-center text-center">
        <div class="flex gap-4 mb-4 text-stone-700">
            <i class="fa-solid fa-tractor text-2xl"></i>
            <i class="fa-solid fa-cow text-2xl"></i>
            <i class="fa-solid fa-seedling text-2xl"></i>
        </div>
        <h3 class="text-stone-300 font-bold text-sm">Straw Market Thailand</h3>
        <p class="text-[10px] mt-2 max-w-md opacity-60">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ ‚Ä¢ Dark Mode</p>
    </div>
</footer>

<!-- Image Slider Modal -->
<div id="imageSlider" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center slider-hidden transition-all duration-300 touch-none">
    <button onclick="closeImageSlider()" class="absolute top-6 right-6 text-white w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full backdrop-blur-xl z-[110] transition-colors">
        <i class="fa-solid fa-xmark text-xl"></i>
    </button>
    <div class="relative w-full h-full flex items-center justify-center p-4">
        <button onclick="changeSlide(-1)" class="absolute left-6 text-white w-12 h-12 hidden md:flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-full z-[110]"><i class="fa-solid fa-chevron-left text-xl"></i></button>
        <img id="sliderMainImage" src="" class="max-w-full max-h-[85vh] object-contain rounded-2xl shadow-2xl transition-all duration-500" onerror="this.src='https://placehold.co/800x600/1c1917/fbbf24?text=Image+Error'">
        <button onclick="changeSlide(1)" class="absolute right-6 text-white w-12 h-12 hidden md:flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-full z-[110]"><i class="fa-solid fa-chevron-right text-xl"></i></button>
    </div>
    <div class="absolute bottom-10 flex flex-col items-center gap-4 z-[110]">
        <span id="sliderCounter" class="text-white text-[10px] bg-white/10 px-4 py-1.5 rounded-full font-mono border border-white/10 backdrop-blur-md">1 / 1</span>
        <div class="flex gap-3 md:hidden">
            <button onclick="changeSlide(-1)" class="w-12 h-12 bg-white/10 rounded-xl text-white flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="changeSlide(1)" class="w-12 h-12 bg-white/10 rounded-xl text-white flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<!-- View Detail Dialog -->
<dialog id="viewDlg" class="rounded-[2rem] shadow-2xl p-0 w-[95%] max-w-2xl m-auto overflow-hidden">
    <div class="relative h-60 sm:h-80 bg-stone-800">
        <div id="detailImageHero" class="w-full h-full cursor-pointer overflow-hidden">
            <img id="viewHeroImg" src="" class="w-full h-full object-cover hover:scale-105 transition-transform duration-700" onerror="handleImgError(this)">
        </div>
        
        <div class="absolute top-4 right-4 flex gap-2 z-10">
            <button id="btnDeletePost" class="bg-black/50 hover:bg-red-900/80 backdrop-blur-md text-red-500 w-9 h-9 rounded-full flex items-center justify-center transition-all shadow-md" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®">
                <i class="fa-solid fa-trash-can text-sm"></i>
            </button>
            <button onclick="closeViewModal()" class="bg-black/50 hover:bg-stone-800 backdrop-blur-md text-white w-9 h-9 rounded-full flex items-center justify-center transition-all shadow-md">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>

        <div class="absolute bottom-4 left-4 right-4 flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="viewImages"></div>
    </div>
    
    <div class="p-6 sm:p-8 overflow-y-auto max-h-[60vh]">
        <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-6">
            <div>
                <h2 id="viewTitle" class="text-xl sm:text-2xl font-bold text-white leading-tight mb-1"></h2>
                <div class="flex flex-wrap gap-2 mt-2">
                    <span class="bg-amber-900/30 text-amber-400 text-[10px] px-2 py-0.5 rounded-lg border border-amber-800/50 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-location-dot"></i> <span id="viewProvince"></span>
                    </span>
                    <span id="viewAddressTag" class="bg-stone-800 text-stone-400 text-[10px] px-2 py-0.5 rounded-lg border border-stone-700 font-bold flex items-center gap-1">
                        <i class="fa-solid fa-map-pin"></i> <span id="viewAddress"></span>
                    </span>
                </div>
            </div>
            <div class="flex flex-col items-start md:items-end">
                <span class="text-[9px] font-bold text-stone-500 uppercase tracking-widest mb-0.5">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡πâ‡∏≠‡∏ô</span>
                <p id="viewPrice" class="text-2xl sm:text-3xl font-black text-[#fbbf24]"></p>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-stone-900/50 p-3 rounded-2xl border border-stone-800 flex items-center gap-3">
                <div class="w-10 h-10 bg-stone-800 rounded-xl flex items-center justify-center text-amber-500 shadow-sm flex-shrink-0 border border-stone-700"><i class="fa-solid fa-user text-sm"></i></div>
                <div class="min-w-0">
                    <p class="text-[9px] text-stone-500 font-bold uppercase">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>
                    <p id="viewContact" class="font-bold text-stone-200 text-sm truncate"></p>
                </div>
            </div>
            <div class="bg-stone-900/50 p-3 rounded-2xl border border-stone-800 flex items-center gap-3">
                <div class="w-10 h-10 bg-stone-800 rounded-xl flex items-center justify-center text-amber-500 shadow-sm flex-shrink-0 border border-stone-700"><i class="fa-solid fa-phone text-sm"></i></div>
                <div class="min-w-0">
                    <p class="text-[9px] text-stone-500 font-bold uppercase">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
                    <p id="viewPhoneText" class="font-bold text-stone-200 text-sm truncate"></p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h4 class="text-xs font-bold text-amber-500 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-align-left text-amber-600"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            </h4>
            <div id="viewBody" class="whitespace-pre-line text-stone-300 bg-black/30 p-4 rounded-2xl border border-stone-800 leading-relaxed text-xs"></div>
            <p id="viewPublishDate" class="text-[9px] text-stone-500 mt-3 italic text-right"></p>
        </div>

        <div class="flex gap-3">
            <a id="btnCall" href="#" class="flex-1 bg-amber-500 text-stone-900 py-3.5 rounded-xl text-center font-bold shadow-lg flex items-center justify-center gap-2 btn-animate transition-all hover:bg-amber-400 text-sm">
                <i class="fa-solid fa-phone-flip"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
            </a>
        </div>
    </div>
</dialog>

<!-- Add/Edit Dialog -->
<dialog id="dlg" class="rounded-[2rem] shadow-2xl p-0 w-[95%] max-w-xl m-auto overflow-hidden">
    <div class="px-6 py-5 border-b border-stone-800 flex justify-between items-center bg-stone-900/50">
        <div>
            <h3 id="dlgTitle" class="text-lg font-bold text-[#fbbf24]">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏ü‡∏≤‡∏á</h3>
        </div>
        <button onclick="closeModal()" class="text-stone-500 hover:text-stone-300 w-9 h-9 rounded-full flex items-center justify-center bg-stone-800 border border-stone-700 shadow-sm"><i class="fa-solid fa-xmark text-lg"></i></button>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[70vh] space-y-5" id="formContainer">
        <div class="space-y-3">
            <div>
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span></label>
                <input id="title" type="text" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥‡∏≠‡∏±‡∏î‡∏Å‡πâ‡∏≠‡∏ô...">
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                 <div>
                    <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="text-red-500">*</span></label>
                    <select id="input_province" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium appearance-none cursor-pointer">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                    </select>
                </div>
                <div class="relative">
                    <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡πâ‡∏≠‡∏ô <span class="text-red-500">*</span></label>
                    <input id="price" type="number" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium pr-14" placeholder="0">
                    <span class="absolute right-4 bottom-3.5 text-[9px] font-bold text-stone-500">‡∏ö./‡∏Å‡πâ‡∏≠‡∏ô</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <input id="contact_name" type="text" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label>
                    <input id="phone" type="tel" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
                </div>
            </div>

            <div class="space-y-3">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1 ml-1 tracking-widest">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <input id="address" type="text" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏ï‡∏≥‡∏ö‡∏• (‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)">
                <textarea id="body" rows="3" class="w-full px-4 py-3 rounded-xl outline-none text-sm font-medium resize-none" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏∑‡πà‡∏ô‡πÜ..."></textarea>
            </div>
        </div>
        
        <div>
            <div class="flex justify-between items-center mb-3">
                <label class="block text-[10px] font-bold text-stone-500 uppercase ml-1 tracking-widest">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <span id="imgCount" class="text-[9px] bg-stone-800 text-amber-500 px-3 py-1 rounded-full font-bold border border-stone-700">0 / 3</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div id="previewList" class="contents"></div>
                <label id="uploadBtn" class="aspect-square border-2 border-dashed border-stone-700 rounded-xl cursor-pointer bg-stone-900/50 hover:bg-stone-800 hover:border-amber-500 flex flex-col items-center justify-center text-stone-600 transition-all group">
                    <i class="fa-solid fa-camera text-xl group-hover:scale-110 transition-transform"></i>
                    <span class="text-[8px] mt-1.5 font-bold uppercase">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</span>
                    <input id="img" type="file" class="hidden" accept="image/*" multiple onchange="appendImages(this)">
                </label>
            </div>
        </div>
    </div>
    
    <div class="p-6 border-t border-stone-800 flex gap-3 bg-stone-900/50">
        <button onclick="closeModal()" class="flex-1 px-4 py-3.5 border border-stone-700 rounded-xl text-stone-400 font-bold text-sm hover:bg-stone-800">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button onclick="savePost()" id="btnSave" class="flex-[2] bg-amber-500 text-stone-900 py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 btn-animate transition-all hover:bg-amber-400 text-sm">
            <span id="btnSaveText">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span> 
            <i id="btnSaveIcon" class="fa-solid fa-check-circle"></i>
        </button>
    </div>
</dialog>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbySGZ60_4wuj9mYaZe3-BJJRtDF0weo3zTE7iAJCIIqJNiTxa5iMRPqHP84LicxbXaH/exec"; 

const PROVINCES = ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"].sort();

let posts = [];
let filteredPosts = [];
let currentPage = 1;
const ITEMS_PER_PAGE = 12; 
let formImages = [];
let sliderImages = [];
let sliderIndex = 0;

const dom = {
    loading: document.getElementById('loading'),
    board: document.getElementById('board'),
    pageIndicator: document.getElementById('pageIndicator'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    dlg: document.getElementById('dlg'),
    viewDlg: document.getElementById('viewDlg'),
    btnSaveText: document.getElementById('btnSaveText'),
    title: document.getElementById('title'),
    price: document.getElementById('price'),
    province: document.getElementById('input_province'),
    contactName: document.getElementById('contact_name'),
    phone: document.getElementById('phone'),
    address: document.getElementById('address'),
    body: document.getElementById('body'),
    imgPreview: document.getElementById('previewList'),
    imgCount: document.getElementById('imgCount'),
    uploadBtn: document.getElementById('uploadBtn'),
    filterDesktop: document.getElementById('filter_province_desktop'),
    filterMobile: document.getElementById('filter_province_mobile'),
    qDesktop: document.getElementById('q_desktop'),
    qMobile: document.getElementById('q_mobile'),
    slider: document.getElementById('imageSlider'),
    sliderImg: document.getElementById('sliderMainImage'),
    sliderCount: document.getElementById('sliderCounter'),
    viewHero: document.getElementById('viewHeroImg'),
    viewDate: document.getElementById('viewPublishDate')
};

function handleImgError(img) {
    img.src = 'https://placehold.co/800x600/1c1917/fbbf24?text=No+Image';
    img.classList.add('img-fallback');
}

function setScrollLock(lock) {
    if (lock) document.body.classList.add('no-scroll');
    else document.body.classList.remove('no-scroll');
}

function init() {
    populateProvinces();
    loadPosts();
    [dom.qDesktop, dom.qMobile].forEach(el => el.addEventListener('input', debounce(applyFilters, 400)));
    [dom.filterDesktop, dom.filterMobile].forEach(el => el.addEventListener('change', (e) => {
        dom.filterDesktop.value = e.target.value;
        dom.filterMobile.value = e.target.value;
        applyFilters();
    }));

    const requiredFields = ['title', 'price', 'input_province', 'phone'];
    requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', () => el.classList.remove('field-error'));
            if (el.tagName === 'SELECT') {
                el.addEventListener('change', () => el.classList.remove('field-error'));
            }
        }
    });
}

function populateProvinces() {
    const html = PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
    dom.province.innerHTML = `<option value="">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>${html}`;
    dom.filterDesktop.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>${html}`;
    dom.filterMobile.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà</option>${html}`;
}

function parseImages(imgData) {
    if (!imgData) return [];
    let result = [];
    if (Array.isArray(imgData)) {
        result = imgData;
    } else if (typeof imgData === 'string') {
        const trimmed = imgData.trim();
        if (trimmed.startsWith('[')) {
            try { result = JSON.parse(trimmed); } catch (e) { result = []; }
        } else if (trimmed !== "" && trimmed !== "null") {
            result = [trimmed];
        }
    }
    return result.map(url => {
        if (typeof url === 'string' && url.includes('id=')) {
            const id = url.split('id=')[1].split('&')[0];
            return `https://lh3.googleusercontent.com/d/${id}`;
        }
        return url;
    });
}

async function loadPosts() {
    dom.loading.classList.remove('hidden');
    dom.board.innerHTML = '';
    try {
        const cacheBuster = `?t=${Date.now()}`;
        const res = await fetch(API_URL + cacheBuster);
        const data = await res.json();
        posts = (Array.isArray(data) ? data : data.data || []).map(p => {
            return { ...p, images: parseImages(p.images) };
        }).reverse();
    } catch (e) {
        console.error("Load failed:", e);
        posts = []; 
    } finally {
        dom.loading.classList.add('hidden');
        applyFilters();
    }
}

function applyFilters() {
    const q = (dom.qDesktop.value || dom.qMobile.value).toLowerCase();
    const prov = dom.filterDesktop.value;
    filteredPosts = posts.filter(p => {
        const titleStr = String(p.title || '');
        const bodyStr = String(p.body || '');
        const addrStr = String(p.address || '');
        const provStr = String(p.province || '');
        const phoneStr = String(p.phone || '');
        const textMatch = (titleStr + bodyStr + addrStr + provStr + phoneStr).toLowerCase().includes(q);
        const provMatch = prov === 'all' || p.province === prov;
        return textMatch && provMatch;
    });
    currentPage = 1;
    renderBoard();
}

function renderBoard() {
    dom.board.innerHTML = '';
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const items = filteredPosts.slice(start, start + ITEMS_PER_PAGE);
    if (items.length === 0) {
        dom.board.innerHTML = `<div class="col-span-full py-16 text-center text-stone-600 flex flex-col items-center gap-2">
            <p class="text-[10px] font-bold uppercase tracking-widest">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>`;
    } else {
        items.forEach(p => {
            let thumb = 'https://placehold.co/400x400/1c1917/fbbf24?text=No+Image';
            if (p.images && p.images.length > 0) {
                thumb = p.images[0];
                if (typeof thumb === 'string' && thumb.includes('id=')) {
                    const id = thumb.split('id=')[1].split('&')[0];
                    thumb = `https://lh3.googleusercontent.com/d/${id}`;
                }
            }
            const card = document.createElement('div');
            card.className = "bg-stone-800 rounded-2xl overflow-hidden shadow-sm border border-stone-700 flex flex-col cursor-pointer active:scale-95 transition-all duration-300";
            card.onclick = () => viewDetail(p.id);
            card.innerHTML = `
                <div class="aspect-square bg-stone-900 overflow-hidden relative">
                    <img src="${thumb}" class="w-full h-full object-cover opacity-90" 
                         onerror="this.src='https://placehold.co/400x400/1c1917/fbbf24?text=Error'">
                    <div class="absolute bottom-1 right-1 bg-black/60 backdrop-blur-md px-1.5 py-0.5 rounded-lg text-[8px] font-bold shadow-sm text-amber-400 border border-white/5">
                        ${p.province}
                    </div>
                </div>
                <div class="p-2 flex flex-col flex-grow">
                    <h3 class="font-bold text-amber-100 text-[10px] sm:text-xs line-clamp-2 leading-tight mb-1 h-6 sm:h-8">${p.title}</h3>
                    <div class="mt-auto flex items-baseline gap-0.5">
                        <span class="text-amber-500 font-black text-xs sm:text-base">‡∏ø${Number(p.price || 0).toLocaleString()}</span>
                    </div>
                </div>
            `;
            dom.board.appendChild(card);
        });
    }
    updatePagination();
}

function updatePagination() {
    const total = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE) || 1;
    dom.pageIndicator.textContent = `${currentPage} / ${total}`;
    dom.btnPrev.disabled = currentPage === 1;
    dom.btnNext.disabled = currentPage === total;
}

function changePage(delta) {
    currentPage += delta;
    renderBoard();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function openNewPostModal() { resetForm(); dom.dlg.showModal(); setScrollLock(true); }
function closeModal() { dom.dlg.close(); setScrollLock(false); }

function viewDetail(id) {
    const p = posts.find(x => x.id === id);
    if (!p) return;
    let heroSrc = 'https://placehold.co/800x600/1c1917/fbbf24?text=Straw+Market';
    if (p.images && p.images.length > 0) {
        heroSrc = p.images[0];
        if (typeof heroSrc === 'string' && heroSrc.includes('id=')) {
            const id = heroSrc.split('id=')[1].split('&')[0];
            heroSrc = `https://lh3.googleusercontent.com/d/${id}`;
        }
    }
    dom.viewHero.src = heroSrc;
    document.getElementById('viewTitle').textContent = p.title;
    document.getElementById('viewPrice').textContent = `‡∏ø${Number(p.price || 0).toLocaleString()}`;
    document.getElementById('viewContact').textContent = p.contact_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    document.getElementById('viewPhoneText').textContent = p.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';
    document.getElementById('viewProvince').textContent = p.province;
    const addrTag = document.getElementById('viewAddressTag');
    if (p.address) {
        document.getElementById('viewAddress').textContent = p.address;
        addrTag.style.display = 'flex';
    } else {
        addrTag.style.display = 'none';
    }
    document.getElementById('viewBody').textContent = p.body || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
    dom.viewDate.textContent = "‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + (p.id ? new Date(p.id).toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric', hour: '2-digit', minute: '2-digit' }) : "-");
    const phoneToCall = p.phone || (p.body ? String(p.body).match(/0\d{8,9}/)?.[0] : null);
    const callBtn = document.getElementById('btnCall');
    callBtn.href = phoneToCall ? `tel:${phoneToCall}` : "#";
    callBtn.style.opacity = phoneToCall ? "1" : "0.5";
    callBtn.innerHTML = phoneToCall ? `<i class="fa-solid fa-phone-flip"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ${phoneToCall}` : `<i class="fa-solid fa-phone-slash"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠`;
    const imgBox = document.getElementById('viewImages');
    imgBox.innerHTML = '';
    sliderImages = (p.images && p.images.length > 0) ? p.images : [];
    if (sliderImages.length > 0) {
        sliderImages.forEach((url, i) => {
            const img = document.createElement('img');
            let thumbUrl = url;
            if (typeof thumbUrl === 'string' && thumbUrl.includes('id=')) {
                const id = thumbUrl.split('id=')[1].split('&')[0];
                thumbUrl = `https://lh3.googleusercontent.com/d/${id}`;
            }
            img.src = thumbUrl;
            img.className = `h-10 w-14 rounded-lg object-cover border-2 transition-all cursor-pointer flex-shrink-0 ${i===0?'border-amber-500':'border-stone-700 bg-stone-900'}`;
            img.onclick = (e) => { e.stopPropagation(); openSlider(i); };
            img.onerror = () => { img.src = 'https://placehold.co/100x100/1c1917/fbbf24?text=Error'; };
            imgBox.appendChild(img);
        });
        document.getElementById('detailImageHero').onclick = () => openSlider(0);
    } else {
        document.getElementById('detailImageHero').onclick = null;
    }
    document.getElementById('btnDeletePost').onclick = (e) => { e.stopPropagation(); confirmDelete(p.id); };
    dom.viewDlg.showModal();
    setScrollLock(true);
}

function closeViewModal() { dom.viewDlg.close(); setScrollLock(false); }

async function confirmDelete(id) {
    closeViewModal(); 
    const res = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®?',
        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Sheets ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#292524',
        confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        background: '#1c1917',
        color: '#fef3c7'
    });
    if (res.isConfirmed) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, background: '#1c1917', color: '#fef3c7', didOpen: () => Swal.showLoading() });
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', id: id }) });
            setTimeout(() => { loadPosts(); Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false, background: '#1c1917', color: '#fef3c7' }); }, 1000);
        } catch (err) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error', { background: '#1c1917', color: '#fef3c7' }); }
    }
}

function appendImages(input) {
    const files = Array.from(input.files);
    const limit = 3 - formImages.length;
    files.slice(0, limit).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => { formImages.push(e.target.result); renderPreview(); };
        reader.readAsDataURL(file);
    });
}

function renderPreview() {
    dom.imgPreview.innerHTML = '';
    formImages.forEach((src, i) => {
        const div = document.createElement('div');
        div.className = "relative aspect-square rounded-xl overflow-hidden border border-stone-700 shadow-sm";
        div.innerHTML = `<img src="${src}" class="w-full h-full object-cover">
            <button onclick="removeImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-md text-[8px] flex items-center justify-center shadow-md"><i class="fa-solid fa-xmark"></i></button>`;
        dom.imgPreview.appendChild(div);
    });
    dom.imgCount.textContent = `${formImages.length} / 3`;
    dom.uploadBtn.classList.toggle('hidden', formImages.length >= 3);
}

function removeImg(i) { formImages.splice(i, 1); renderPreview(); }

async function savePost() {
    const validations = [{ el: dom.title, name: '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' }, { el: dom.province, name: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' }, { el: dom.price, name: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡πâ‡∏≠‡∏ô' }, { el: dom.phone, name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' }];
    validations.forEach(v => v.el.classList.remove('field-error'));
    const missing = validations.filter(v => !v.el || !v.el.value.trim());
    if (missing.length > 0) {
        missing.forEach((m, idx) => { if (m.el) { m.el.classList.add('field-error'); if (idx === 0) m.el.focus(); } });
        return;
    }
    const btn = document.getElementById('btnSave');
    if (!btn || !dom.btnSaveText) return;
    btn.disabled = true;
    const originalText = dom.btnSaveText.textContent;
    dom.btnSaveText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
    const payload = { action: 'add', id: Date.now(), title: dom.title.value, price: Number(dom.price.value), province: dom.province.value, address: dom.address.value, contact_name: dom.contactName.value, phone: dom.phone.value, body: dom.body.value, images: formImages };
    try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        closeModal();
        Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...', icon: 'success', timer: 2000, showConfirmButton: false, background: '#1c1917', color: '#fef3c7' });
        setTimeout(() => { loadPosts(); }, 1500);
    } catch (err) { Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error', { background: '#1c1917', color: '#fef3c7' }); } finally { btn.disabled = false; dom.btnSaveText.textContent = originalText; }
}

function openSlider(i) {
    sliderIndex = i;
    updateSlider();
    if (dom.viewDlg.open) dom.viewDlg.close(); 
    dom.slider.classList.remove('slider-hidden');
    dom.slider.classList.add('slider-visible');
    setScrollLock(true);
}

function closeImageSlider() {
    dom.slider.classList.add('slider-hidden');
    dom.slider.classList.remove('slider-visible');
    setScrollLock(false);
}

function changeSlide(n) {
    sliderIndex = (sliderIndex + n + sliderImages.length) % sliderImages.length;
    updateSlider();
}

function updateSlider() {
    let currentImg = sliderImages[sliderIndex];
    if (typeof currentImg === 'string' && currentImg.includes('id=')) {
        const id = currentImg.split('id=')[1].split('&')[0];
        currentImg = `https://lh3.googleusercontent.com/d/${id}`;
    }
    dom.sliderImg.src = currentImg;
    dom.sliderCount.textContent = `${sliderIndex + 1} / ${sliderImages.length}`;
}

function debounce(fn, t) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), t);
    };
}

function resetForm() {
    dom.title.value = ''; dom.price.value = ''; dom.province.value = '';
    dom.contactName.value = ''; dom.phone.value = ''; dom.address.value = ''; dom.body.value = '';
    formImages = []; 
    [dom.title, dom.price, dom.province, dom.phone].forEach(el => { if (el) el.classList.remove('field-error'); });
    renderPreview();
}

function refreshApp() {
    dom.qDesktop.value = ''; dom.qMobile.value = '';
    dom.filterDesktop.value = 'all'; dom.filterMobile.value = 'all';
    loadPosts();
}

init();
</script>
</body>
</html>
